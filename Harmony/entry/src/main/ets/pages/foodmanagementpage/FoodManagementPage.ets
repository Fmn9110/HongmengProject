import router from '@ohos.router';
import dietRecommendationService from '../../services/DietRecommendationService';
import { FoodItem } from '../childpages/dietpage/FoodData';
import { DiseaseTemplate, getAllDiseaseNames, getDiseaseByName } from '../childpages/medicalhistorypage/DiseaseData';
import { loadMedicalRecordsFromStorage } from '../childpages/medicalhistorypage/MedicalHistoryModel';

// å®šä¹‰é¢œè‰²å¸¸é‡
const PRIMARY_TEXT_COLOR: ResourceColor = Color.Black;
const SECONDARY_TEXT_COLOR: ResourceColor = '#666666';
const ACCENT_COLOR: ResourceColor = '#007DFF';
const LIGHT_BLUE: ResourceColor = '#f6f8ff';
const DIVIDER_COLOR: ResourceColor = '#ff989898';
const TOP_BAR_COLOR: ResourceColor = '#007DFF'; // æ›¿æ¢æ¸å˜ä¸ºçº¯è‰²
const GLASS_WHITE: ResourceColor = '#33FFFFFF'; // 20% é€æ˜åº¦çš„ç™½è‰²
const GLASS_BORDER: ResourceColor = '#80FFFFFF'; // 50% é€æ˜åº¦çš„ç™½è‰²

// é¥®é£Ÿè®°å½•æ•°æ®æ ¼å¼
interface FoodRecord {
  id: number;
  mealType: 'æ—©é¤' | 'åˆé¤' | 'æ™šé¤' | 'å…¶ä»–';
  foodName: string;
  calories: number;
  recordedAt: string;
}

// è¥å…»åˆ†ææ•°æ®æ ¼å¼
interface NutritionSummary {
  totalCalories: number;
  protein: number;
  fat: number;
  carbohydrates: number;
}

// æ·»åŠ DiseaseRecordDTOæ¥å£ç”¨äºä¼ é€’ç»™é¥®é£Ÿæ¨èé¡µé¢
interface DiseaseRecordDTO {
  name: string;
  diagnosisDate: string;
  severity: string;
  description: string;
  status: string;
}

// é¤é¥®ç®¡ç†é¡µé¢ä¸»ç»„ä»¶
@Entry
@Component
struct FoodManagementPage {
  @State foodRecords: FoodRecord[] = [
    {
      id: 1,
      mealType: 'æ—©é¤',
      foodName: 'ç‡•éº¦ç²¥',
      calories: 200,
      recordedAt: '2025-05-12 08:00'
    },
    {
      id: 2,
      mealType: 'åˆé¤',
      foodName: 'é¸¡èƒ¸è‚‰æ²™æ‹‰',
      calories: 350,
      recordedAt: '2025-05-12 12:30'
    },
    {
      id: 3,
      mealType: 'æ™šé¤',
      foodName: 'æ¸…è’¸é±¼',
      calories: 300,
      recordedAt: '2025-05-12 18:30'
    }
  ];
  @State nutritionSummary: NutritionSummary = {
    totalCalories: 850,
    protein: 60,
    fat: 25,
    carbohydrates: 100
  };
  @State refreshing: boolean = false;
  @State overscrollOffset: number = 0;
  @State aiRecommendation: string = '';
  @State isLoadingRecommendation: boolean = true;
  @State userDiseases: string[] = [];
  @State recommendedFoods: FoodItem[] = [];
  @State diseaseWithSeverity: Map<string, string> = new Map(); // æ–°å¢ç–¾ç—…å’Œä¸¥é‡ç¨‹åº¦çš„æ˜ å°„
  private dailyCalorieGoal: number = 2000; // æ¯æ—¥æ¨èçƒ­é‡

  aboutToAppear() {
    // ä»ç—…å²è®°å½•è·å–çœŸå®çš„ç”¨æˆ·ç–¾ç—…æ•°æ®
    this.loadUserDiseases();
  }

  // å½“é¡µé¢æ˜¾ç¤ºæ—¶ï¼ˆå¦‚ä»ç—…å²ç®¡ç†é¡µé¢è¿”å›ï¼‰é‡æ–°åŠ è½½æ•°æ®
  onPageShow() {
    // é‡æ–°åŠ è½½æœ€æ–°çš„ç”¨æˆ·ç–¾ç—…æ•°æ®
    this.loadUserDiseases();
  }

  // æ–°å¢åŠ è½½ç”¨æˆ·ç–¾ç—…è®°å½•çš„æ–¹æ³•
  async loadUserDiseases() {
    try {
      // ä»å­˜å‚¨ä¸­åŠ è½½åŒ»ç–—è®°å½•
      const records = await loadMedicalRecordsFromStorage();
      if (records && records.length > 0) {
        // æå–ç–¾ç—…åç§°
        this.userDiseases = records.map(record => record.diseaseName);

        // æå–ç–¾ç—…ä¸¥é‡ç¨‹åº¦å¹¶ä¿å­˜åˆ°æ˜ å°„ä¸­
        const severities: Record<string, string> = {};
        for (let i = 0; i < records.length; i++) {
          const record = records[i];
          this.diseaseWithSeverity.set(record.diseaseName, record.severity);
          severities[record.diseaseName] = record.severity;
        }

        // è®¾ç½®ç–¾ç—…ä¸¥é‡ç¨‹åº¦åˆ°æ¨èæœåŠ¡
        dietRecommendationService.setDiseaseSeverities(severities);
      } else {
        this.userDiseases = [];
      }

      // å°†ç”¨æˆ·ç–¾ç—…è®¾ç½®åˆ°é¤é¥®æ¨èæœåŠ¡
      dietRecommendationService.setUserDiseases(this.userDiseases);

      // ç”ŸæˆAIæ¨è
      this.generateAIRecommendation();
    } catch (error) {
      console.error('Failed to load user diseases:', error);
      // ä½¿ç”¨é»˜è®¤ç¤ºä¾‹æ•°æ®ä½œä¸ºåå¤‡
      this.userDiseases = ['é«˜è¡€å‹', 'ç³–å°¿ç—…'];
      dietRecommendationService.setUserDiseases(this.userDiseases);
      this.generateAIRecommendation();
    }
  }

  // ç”ŸæˆAIæ¨èå†…å®¹
  private generateAIRecommendation() {
    // è·å–ç–¾ç—…å¯¹è±¡åˆ—è¡¨
    const diseaseObjects: DiseaseTemplate[] = [];
    for (let i = 0; i < this.userDiseases.length; i++) {
      const disease = getDiseaseByName(this.userDiseases[i]);
      if (disease) {
        diseaseObjects.push(disease);
      }
    }

    this.aiRecommendation = dietRecommendationService.simulateAIRecommendation(diseaseObjects);
    // æ›´æ–°æ¨èé£Ÿç‰©åˆ—è¡¨
    const recommendation = dietRecommendationService.getPersonalizedDietRecommendation();
    this.recommendedFoods = recommendation.recommendedFoods.slice(0, 4);
    this.isLoadingRecommendation = false;
  }

  // å¤„ç†é¡¶éƒ¨/åº•éƒ¨å¼¹æ€§å›å¼¹åŠ¨ç”»
  private handleOverscroll(edge: Edge): void {
    if (edge === Edge.Bottom || edge === Edge.Top) {
      this.overscrollOffset = edge === Edge.Bottom ? -50 : 50;
      animateTo({
        duration: 600,
        curve: Curve.Friction,
        onFinish: () => {
          this.overscrollOffset = 0;
        }
      }, () => {
        this.overscrollOffset = 0;
      });
    }
  }

  // åˆ é™¤é¥®é£Ÿè®°å½•
  private deleteRecord(id: number): void {
    const recordToDelete = this.foodRecords.find(record => record.id === id);
    if (recordToDelete) {
      this.foodRecords = this.foodRecords.filter(record => record.id !== id);
      this.updateNutritionSummary(-recordToDelete.calories);
    }
  }

  // ç¼–è¾‘é¥®é£Ÿè®°å½•
  private editRecord(id: number): void {
    const recordToEdit = this.foodRecords.find(record => record.id === id);
    if (recordToEdit) {
      router.pushUrl({
        url: 'pages/editFoodRecord/EditFoodRecordPage',
        params: { record: recordToEdit }
      });
    }
  }

  // æ›´æ–°è¥å…»åˆ†æ
  private updateNutritionSummary(caloriesChange: number): void {
    this.nutritionSummary.totalCalories += caloriesChange;
    this.nutritionSummary.protein += caloriesChange * 0.1;
    this.nutritionSummary.fat += caloriesChange * 0.05;
    this.nutritionSummary.carbohydrates += caloriesChange * 0.15;
  }

  build() {
    Stack({ alignContent: Alignment.TopStart }) {
      Column() {
        // è‡ªå®šä¹‰é¡¶éƒ¨æ ï¼ˆä¸è¿åŠ¨æ¨èé¡µé¢ä¿æŒä¸€è‡´ï¼‰
        this.buildCustomAppBar()

        Refresh({ refreshing: this.refreshing, offset: 50, friction: 0.6 }) {
          Scroll() {
            Column({ space: 12 }) {
              this.buildNutritionSummaryCard()
              this.buildFoodRecordsCard()
              this.buildAIDietRecommendationCard()
              this.buildDietAdviceCard()
              this.buildDailyGoalCard()
              this.buildActionButtons()
              Blank()
                .height(this.overscrollOffset)
              Blank()
                .height(100)
            }
            .width('100%')
            .backgroundColor(LIGHT_BLUE)
            .padding({ left: 8, right: 8 })
          }
          .edgeEffect(EdgeEffect.Spring)
          .onScrollEdge((edge: Edge) => {
            this.handleOverscroll(edge);
          })
        }
        .onRefreshing(() => {
          this.refreshing = true;

          // é‡æ–°åŠ è½½ç”¨æˆ·ç–¾ç—…æ•°æ®
          this.loadUserDiseases();

          this.foodRecords = [
            {
              id: 1,
              mealType: 'æ—©é¤',
              foodName: 'ç‡•éº¦ç²¥',
              calories: 200,
              recordedAt: '2025-05-12 08:00'
            },
            {
              id: 2,
              mealType: 'åˆé¤',
              foodName: 'é¸¡èƒ¸è‚‰æ²™æ‹‰',
              calories: 350,
              recordedAt: '2025-05-12 12:30'
            },
            {
              id: 3,
              mealType: 'æ™šé¤',
              foodName: 'æ¸…è’¸é±¼',
              calories: 300,
              recordedAt: '2025-05-12 18:30'
            }
          ];

          this.nutritionSummary = {
            totalCalories: 850,
            protein: 60,
            fat: 25,
            carbohydrates: 100
          };

          // å»¶è¿Ÿç»“æŸåˆ·æ–°çŠ¶æ€
          setTimeout(() => {
            this.refreshing = false;
          }, 1000);
        })
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height('92%')
    .margin({ top: 35 })
  }

  // é¡¶éƒ¨è‡ªå®šä¹‰AppBarï¼ˆä¸è¿åŠ¨æ¨èé¡µé¢ä¿æŒä¸€è‡´ï¼‰
  @Builder
  buildCustomAppBar() {
    Column() {
      Row() {
        Image($r("app.media.ic_back_black"))
          .width(22)
          .height(22)
          .margin({ left: 5 })
          .onClick(() => {
            router.back()
          })
        Blank()
        Text('é¤é¥®ç®¡ç†')
          .fontSize(22)
          .margin({ left: 15 })
          .textAlign(TextAlign.Center)
          .fontWeight(FontWeight.Bold)
          .fontColor(PRIMARY_TEXT_COLOR)
        Blank()
        Row() {
          Image($r("app.media.ic_mores"))
            .width(25)
            .height(25)
            .margin({ right: 10 })
        }
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .height(56)
      .padding({ left: 12, right: 12 })
      .backgroundColor('#FFFFFF')
      .zIndex(100)
      .border({ width: 0, color: '#00000000' })
      .shadow({ radius: 4, color: '#00000010' })

      // åº•éƒ¨åˆ†å‰²çº¿
      Divider().color('#ff968989').height(1).width('100%')
    }
  }

  // è¥å…»åˆ†æå¡ç‰‡
  @Builder
  buildNutritionSummaryCard() {
    Column() {
      Row() {
        Text('ä»Šæ—¥è¥å…»åˆ†æ')
          .fontSize(20)
          .fontColor(ACCENT_COLOR)
          .fontWeight(FontWeight.Bold)
        Blank()
        Text('æŸ¥çœ‹å†å² >')
          .fontSize(14)
          .fontColor(SECONDARY_TEXT_COLOR)
          .onClick(() => {
            router.pushUrl({ url: 'pages/foodHistory/FoodHistoryPage' });
          })
      }
      .width('100%')

      Divider()
        .color(DIVIDER_COLOR)
        .margin({ top: 8, bottom: 8 })

      Row() {
        Text(`æ‘„å…¥çƒ­é‡: ${this.nutritionSummary.totalCalories} kcal / ${this.dailyCalorieGoal} kcal`)
          .fontSize(16)
          .fontColor(PRIMARY_TEXT_COLOR)
      }
      .width('100%')
      .padding({ bottom: 8 })

      Row({ space: 12 }) {
        this.buildNutritionItem(`${this.nutritionSummary.protein}g`, 'è›‹ç™½è´¨')
        this.buildNutritionItem(`${this.nutritionSummary.fat}g`, 'è„‚è‚ª')
        this.buildNutritionItem(`${this.nutritionSummary.carbohydrates}g`, 'ç¢³æ°´')
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)
    }
    .padding(16)
    .margin({ left: 8, right: 8, top: 12 })
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: '#00000020',
      offsetX: 4,
      offsetY: 4
    })
    .shadow({
      radius: 8,
      color: '#FFFFFF80',
      offsetX: -4,
      offsetY: -4
    })
  }

  // å•ä¸ªè¥å…»æ•°æ®é¡¹
  @Builder
  buildNutritionItem(value: string, label: string) {
    Column() {
      Text(value)
        .fontSize(20)
        .fontColor(ACCENT_COLOR)
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 5 })
      Text(label)
        .fontSize(14)
        .fontColor(SECONDARY_TEXT_COLOR)
    }
  }

  // é¥®é£Ÿè®°å½•å¡ç‰‡
  @Builder
  buildFoodRecordsCard() {
    Column() {
      Row() {
        Text('ä»Šæ—¥é¥®é£Ÿè®°å½•')
          .fontSize(20)
          .fontColor(ACCENT_COLOR)
          .fontWeight(FontWeight.Bold)
        Blank()
      }
      .width('100%')

      Divider()
        .color(DIVIDER_COLOR)
        .margin({ top: 8, bottom: 20 })

      if (this.foodRecords.length === 0) {
        Text('æš‚æ— é¥®é£Ÿè®°å½•')
          .fontSize(16)
          .fontColor(SECONDARY_TEXT_COLOR)
          .padding(20)
      } else {
        ForEach(this.foodRecords, (record: FoodRecord, index: number) => {
          Row() {
            Text(this.getMealText(record.mealType))
              .fontSize(24)
              .margin({ right: 12 })

            Column({ space: 4 }) {
              Text(record.mealType)
                .fontSize(18)
                .fontColor(PRIMARY_TEXT_COLOR)
                .fontWeight(FontWeight.Bold)
              Text(record.foodName)
                .fontSize(14)
                .fontColor(SECONDARY_TEXT_COLOR)
              Text(record.recordedAt)
                .fontSize(12)
                .fontColor(SECONDARY_TEXT_COLOR)
            }
            .alignItems(HorizontalAlign.Start)
            .margin({ left: 10 })
            .layoutWeight(1)

            Column() {
              Text() {
                Span(`${record.calories} `)
                  .fontSize(20)
                  .fontColor(ACCENT_COLOR)
                  .fontWeight(FontWeight.Medium)
                Span('kcal')
                  .fontSize(14)
                  .fontWeight(FontWeight.Medium)
              }

            }
            .margin({ right: 20 })

            Column({ space: 8 }) {
              Text('ç¼–è¾‘')
                .fontSize(12)
                .fontColor(Color.White)
                .backgroundColor('#ff688dec')
                .padding({
                  left: 8,
                  right: 8,
                  top: 4,
                  bottom: 4
                })
                .borderRadius(4)
                .onClick(() => this.editRecord(record.id))
              Text('åˆ é™¤')
                .fontSize(12)
                .fontColor(Color.White)
                .backgroundColor('#ffff6868')
                .padding({
                  left: 8,
                  right: 8,
                  top: 4,
                  bottom: 4
                })
                .borderRadius(4)
                .onClick(() => this.deleteRecord(record.id))
            }
          }
          .width('100%')
          .padding(12)
          .borderRadius(8)
          .backgroundColor('#f9f9f9')
          .margin({ bottom: 16 })
          .animation({
            duration: 300,
            curve: Curve.EaseInOut
          })
        }, (record: FoodRecord) => record.id.toString())
      }
    }
    .padding(16)
    .margin({ left: 8, right: 8 })
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: '#00000020',
      offsetX: 4,
      offsetY: 4
    })
    .shadow({
      radius: 8,
      color: '#FFFFFF80',
      offsetX: -4,
      offsetY: -4
    })
  }

  // è·å–ç–¾ç—…ä¸¥é‡ç¨‹åº¦æ–‡æœ¬
  private getDiseaseWithSeverity(disease: string): string {
    return this.diseaseWithSeverity.has(disease) ? this.diseaseWithSeverity.get(disease) || 'è½»åº¦' : 'è½»åº¦';
  }

  // AIé¤é¥®æ¨èå¡ç‰‡
  @Builder
  buildAIDietRecommendationCard() {
    Column() {
      if (this.isLoadingRecommendation) {
        Column({ space: 10 }) {
          LoadingProgress()
            .width(50)
            .height(50)
            .color('#4CAF50')

          Text('åŠ è½½ä¸ªæ€§åŒ–é¥®é£Ÿæ¨èä¸­...')
            .fontSize(16)
            .opacity(0.6)
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
      } else if (this.userDiseases.length === 0) {
        Column() {
          Image($r('app.media.medical'))
            .width(80)
            .height(80)
            .margin({ bottom: 16 })

          Text('æš‚æ— ä¸ªæ€§åŒ–é¥®é£Ÿæ¨è')
            .fontSize(18)
            .fontWeight(500)
            .margin({ bottom: 8 })

          Text('è¯·åœ¨ç—…å²ç®¡ç†é¡µé¢æ·»åŠ æ‚¨çš„å¥åº·ä¿¡æ¯ï¼Œä»¥è·å–é’ˆå¯¹æ€§çš„é¥®é£Ÿå»ºè®®')
            .fontSize(14)
            .opacity(0.6)
            .textAlign(TextAlign.Center)
            .margin({ bottom: 16 })

          Button('å‰å¾€ç—…å²ç®¡ç†')
            .width('60%')
            .height(40)
            .backgroundColor('#4CAF50')
            .borderRadius(20)
            .onClick(() => {
              router.pushUrl({
                url: 'pages/childpages/medicalhistorypage/MedicalHistoryPage'
              }).catch((err: Error) => {
                console.error(`Failed to navigate to medical history page: ${err.message}`);
              });
            })
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
      } else {
        // æ˜¾ç¤ºç”¨æˆ·ç–¾ç—…æ ‡ç­¾
        Column() {
          Text('åŸºäºæ‚¨çš„å¥åº·è®°å½•')
            .fontSize(16)
            .fontWeight(500)
            .margin({ bottom: 12 })

          Flex({ wrap: FlexWrap.Wrap }) {
            ForEach(this.userDiseases, (disease: string) => {
              Row() {
                Text(disease)
                  .fontSize(14)
                  .padding({
                    left: 8,
                    right: 8,
                    top: 4,
                    bottom: 4
                  })
                  .textAlign(TextAlign.Center)

                // æ˜¾ç¤ºç–¾ç—…ä¸¥é‡ç¨‹åº¦æ ‡ç­¾
                if (this.diseaseWithSeverity.has(disease)) {
                  Text(this.getDiseaseWithSeverity(disease))
                    .fontSize(12)
                    .fontColor(this.getSeverityColor(this.getDiseaseWithSeverity(disease)))
                    .backgroundColor(this.getSeverityBgColor(this.getDiseaseWithSeverity(disease)))
                    .borderRadius(10)
                    .padding({
                      left: 6,
                      right: 6,
                      top: 2,
                      bottom: 2
                    })
                    .margin({ left: 4 })
                }
              }
              .backgroundColor('#F0F9FF')
              .borderRadius(16)
              .margin({ right: 8, bottom: 8 })
              .padding({
                right: 4
              })
            })
          }
        }
        .width('100%')
        .padding(16)

        // æ˜¾ç¤ºAIæ¨èæ‘˜è¦
        if (this.aiRecommendation) {
          Column() {
            Row() {
              Image($r('app.media.aifood'))
                .width(24)
                .height(24)
                .margin({ right: 8 })

              Text('AIè¥å…»å¸ˆå»ºè®®')
                .fontSize(16)
                .fontWeight(500)
            }
            .width('100%')
            .margin({ top: 16, bottom: 12 })

            Text(this.getAIRecommendationSummary())
              .fontSize(14)
              .lineHeight(22)
              .maxLines(3)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
          }
          .width('100%')
          .padding(16)
        }

        // æŸ¥çœ‹è¯¦ç»†æ¨èæŒ‰é’®
        Button('æŸ¥çœ‹è¯¦ç»†é¥®é£Ÿæ¨è', { type: ButtonType.Normal })
          .width('100%')
          .height(44)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(Color.White)
          .backgroundColor(ACCENT_COLOR)
          .borderRadius(22)
          .shadow({ radius: 8, color: 'rgba(0, 114, 245, 0.2)', offsetY: 2 })
          .margin({ top: 16 })
          .onClick(() => {
            // å°†ç–¾ç—…è®°å½•è½¬æ¢ä¸ºAiDietRecommendationPageéœ€è¦çš„æ ¼å¼
            const diseaseRecords: DiseaseRecordDTO[] = [];
            for (let i = 0; i < this.userDiseases.length; i++) {
              const disease = this.userDiseases[i];
              const severity = this.getDiseaseWithSeverity(disease);

              // åˆ›å»ºç–¾ç—…è®°å½•å¯¹è±¡
              diseaseRecords.push({
                name: disease,
                diagnosisDate: '', // é¤é¥®ç®¡ç†é¡µé¢æ²¡æœ‰è¯Šæ–­æ—¥æœŸä¿¡æ¯ï¼Œç•™ç©º
                severity: severity,
                description: '', // é¤é¥®ç®¡ç†é¡µé¢æ²¡æœ‰è¯¦ç»†æè¿°ï¼Œç•™ç©º
                status: 'æ…¢æ€§ç—…' // é»˜è®¤çŠ¶æ€
              } as DiseaseRecordDTO);
            }

            // è·³è½¬åˆ°é¤é¥®æ¨èé¡µé¢ï¼Œä¼ é€’ç–¾ç—…è®°å½•
            router.pushUrl({
              url: 'pages/childpages/dietpage/AiDietRecommendationPage',
              params: {
                diseaseRecords: diseaseRecords
              }
            }).catch((err: Error) => {
              console.error(`Failed to navigate to diet recommendation page: ${err.message}`);
            });
          })
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .margin({ bottom: 16 })
  }

  // è·å–ä¸¥é‡ç¨‹åº¦å¯¹åº”çš„é¢œè‰²
  getSeverityColor(severity: string): string {
    switch (severity) {
      case 'è½»åº¦':
        return '#22C55E'
      case 'ä¸­åº¦':
        return '#F59E0B'
      case 'é‡åº¦':
        return '#EF4444'
      default:
        return '#22C55E'
    }
  }

  // è·å–ä¸¥é‡ç¨‹åº¦å¯¹åº”çš„èƒŒæ™¯é¢œè‰²
  getSeverityBgColor(severity: string): string {
    switch (severity) {
      case 'è½»åº¦':
        return 'rgba(34, 197, 94, 0.1)'
      case 'ä¸­åº¦':
        return 'rgba(245, 158, 11, 0.1)'
      case 'é‡åº¦':
        return 'rgba(239, 68, 68, 0.1)'
      default:
        return 'rgba(34, 197, 94, 0.1)'
    }
  }

  // é£Ÿç‰©å¡ç‰‡
  @Builder
  FoodCard(food: FoodItem) {
    Column() {
      Row() {
        // Image(food.imageUrl || $r('app.media.default_food'))
        //   .width(50)
        //   .height(50)
        //   .borderRadius(8)
        //   .objectFit(ImageFit.Cover)

        Column({ space: 4 }) {
          Text(food.name)
            .fontSize(16)
            .fontWeight(500)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          Text(food.benefits.slice(0, 1).join(''))
            .fontSize(12)
            .opacity(0.6)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
        .padding({ left: 12 })
      }
      .width('100%')
      .padding(10)
    }
    .width('48%')
    .borderRadius(12)
    .backgroundColor('#F0F9F4')
    .border({ width: 1, color: '#C9E7D8' })
  }

  // é¥®é£Ÿå»ºè®®å¡ç‰‡
  @Builder
  buildDietAdviceCard() {
    Column() {
      Text('é¥®é£Ÿå»ºè®®')
        .fontSize(20)
        .fontColor(ACCENT_COLOR)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 8 })

      Divider()
        .color(DIVIDER_COLOR)
        .margin({ bottom: 16 })

      Text('â€¢ ä¿æŒé¥®é£Ÿå‡è¡¡ï¼Œå¤šæ‘„å…¥è”¬èœå’Œæ°´æœã€‚')
        .fontSize(14)
        .fontColor(SECONDARY_TEXT_COLOR)
        .margin({ bottom: 8 })

      Text('â€¢ æ§åˆ¶æ¯æ—¥çƒ­é‡æ‘„å…¥ï¼Œé¿å…è¿‡é‡ã€‚')
        .fontSize(14)
        .fontColor(SECONDARY_TEXT_COLOR)
        .margin({ bottom: 8 })

      Text('â€¢ å®šæ—¶å®šé‡ï¼Œå…»æˆè‰¯å¥½çš„é¥®é£Ÿä¹ æƒ¯ã€‚')
        .fontSize(14)
        .fontColor(SECONDARY_TEXT_COLOR)
    }
    .width('95%')
    .padding(16)
    .alignItems(HorizontalAlign.Start)
    .margin({ left: 8, right: 8 })
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: '#00000020',
      offsetX: 4,
      offsetY: 4
    })
    .shadow({
      radius: 8,
      color: '#FFFFFF80',
      offsetX: -4,
      offsetY: -4
    })
  }

  // æ¯æ—¥é¥®é£Ÿç›®æ ‡å¡ç‰‡
  @Builder
  buildDailyGoalCard() {
    Column() {
      Text('æ¯æ—¥é¥®é£Ÿç›®æ ‡')
        .fontSize(20)
        .fontColor(ACCENT_COLOR)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 8 })

      Divider()
        .color(DIVIDER_COLOR)
        .margin({ bottom: 8 })

      Row() {
        Text(`çƒ­é‡è¿›åº¦: ${this.nutritionSummary.totalCalories} / ${this.dailyCalorieGoal} kcal`)
          .fontSize(16)
          .fontColor(PRIMARY_TEXT_COLOR)
      }
      .width('100%')
      .margin({ bottom: 8 })

      Row() {
        Row()
          .width(`${Math.min((this.nutritionSummary.totalCalories / this.dailyCalorieGoal) * 100, 100)}%`)
          .height(8)
          .backgroundColor(ACCENT_COLOR)
          .borderRadius(4)
          .animation({
            duration: 500,
            curve: Curve.EaseInOut
          })
        Blank()
      }
      .width('100%')
      .height(8)
      .backgroundColor('#E5E5E5')
      .borderRadius(4)
    }
    .padding(16)
    .margin({ left: 8, right: 8 })
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: '#00000020',
      offsetX: 4,
      offsetY: 4
    })
    .shadow({
      radius: 8,
      color: '#FFFFFF80',
      offsetX: -4,
      offsetY: -4
    })
  }

  // è·å–é¤ç±»å‹æ–‡å­—è¡¨ç¤º
  private getMealText(mealType: string): string {
    switch (mealType) {
      case 'æ—©é¤':
        return 'ğŸ³';
      case 'åˆé¤':
        return 'ğŸ½ï¸';
      case 'æ™šé¤':
        return 'ğŸ´';
      default:
        return 'ğŸ²';
    }
  }

  // æ“ä½œæŒ‰é’®
  @Builder
  buildActionButtons() {
    Row({ space: 12 }) {
      Button('æ·»åŠ é¥®é£Ÿè®°å½•', { type: ButtonType.Normal })
        .fontSize(16)
        .fontColor(Color.White)
        .backgroundColor(TOP_BAR_COLOR)
        .padding({
          left: 20,
          right: 20,
          top: 12,
          bottom: 12
        })
        .borderRadius(10)
        .shadow({ radius: 10, color: '#00000020' })
        .layoutWeight(1)
        .onClick(() => {
          router.pushUrl({ url: 'pages/addFoodRecord/AddFoodRecordPage' });
        })

      Button('ç—…å²ç®¡ç†', { type: ButtonType.Normal })
        .fontSize(16)
        .fontColor(Color.White)
        .backgroundColor(TOP_BAR_COLOR)
        .padding({
          left: 20,
          right: 20,
          top: 12,
          bottom: 12
        })
        .borderRadius(10)
        .shadow({ radius: 10, color: '#00000020' })
        .layoutWeight(1)
        .onClick(() => {
          router.pushUrl({ url: 'pages/childpages/medicalhistorypage/MedicalHistoryPage' });
        })
    }
    .width('100%')
    .padding(16)
  }

  // è·å–AIæ¨èæ‘˜è¦
  private getAIRecommendationSummary(): string {
    // å¦‚æœæ²¡æœ‰æ¨èå†…å®¹ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
    if (!this.aiRecommendation) {
      return '';
    }

    // æå–AIæ¨èçš„å‰150ä¸ªå­—ç¬¦ä½œä¸ºæ‘˜è¦
    let summary = this.aiRecommendation;
    if (summary.length > 150) {
      summary = summary.substring(0, 150) + '...';
    }

    return summary;
  }
}